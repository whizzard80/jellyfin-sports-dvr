<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Sports DVR</title>
</head>
<body>
    <div id="SportsDVRConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-select,emby-checkbox">
        
        <div data-role="content">
            <div class="content-primary">
                <h2>Sports DVR</h2>
                <p>Automatically record sports based on team, league, or event subscriptions.</p>
                
                <form id="SportsDVRConfigForm">
                    
                    <!-- Status Overview -->
                    <fieldset class="verticalSection">
                        <legend>Overview</legend>
                        <div style="display: flex; gap: 2em; flex-wrap: wrap;">
                            <div>
                                <span id="statSubscriptions" style="font-size: 1.5em; font-weight: bold;">0</span>
                                <div class="fieldDescription">Subscriptions</div>
                            </div>
                            <div>
                                <span id="statEnabled" style="font-size: 1.5em; font-weight: bold;">0</span>
                                <div class="fieldDescription">Active</div>
                            </div>
                            <div>
                                <span id="statConcurrent" style="font-size: 1.5em; font-weight: bold;">2</span>
                                <div class="fieldDescription">Max Streams</div>
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Settings -->
                    <fieldset class="verticalSection">
                        <legend>Settings</legend>
                        <p class="fieldDescription">Recording paths and storage are managed by Jellyfin's DVR settings.</p>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="maxConcurrent">Max Concurrent Recordings</label>
                            <input type="number" id="maxConcurrent" min="1" max="10" value="2" is="emby-input">
                            <div class="fieldDescription">Number of tuners/streams available (e.g., 2 for most IPTV)</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="defaultPriority">Default Priority (1-100)</label>
                            <input type="number" id="defaultPriority" min="1" max="100" value="50" is="emby-input">
                            <div class="fieldDescription">Default priority for new subscriptions. Higher wins conflicts.</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="scanInterval">EPG Scan Interval (minutes)</label>
                            <input type="number" id="scanInterval" min="1" max="60" value="5" is="emby-input">
                            <div class="fieldDescription">How often to scan EPG for matching programs.</div>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input type="checkbox" id="enableAutoScheduling" is="emby-checkbox" checked>
                                <span>Enable automatic scheduling from EPG</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">Automatically schedule recordings when matching programs are found.</div>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input type="checkbox" id="enableAliasMatching" is="emby-checkbox" checked>
                                <span>Enable team alias matching</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">Match team name variations (e.g., "Man City" matches "Manchester City").</div>
                        </div>
                        
                        <div>
                            <button is="emby-button" type="button" class="raised button-submit block" onclick="SportsDVR.saveSettings()">
                                <span>Save Settings</span>
                            </button>
                        </div>
                    </fieldset>
                    
                    <!-- Team Aliases -->
                    <fieldset class="verticalSection">
                        <legend>Team Aliases</legend>
                        <p class="fieldDescription">Add custom team name variations. Built-in aliases include common variations.</p>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="aliasTestInput">Test Alias Lookup</label>
                            <div style="display: flex; gap: 0.5em;">
                                <input type="text" id="aliasTestInput" placeholder="Enter team name..." is="emby-input" style="flex: 1;">
                                <button is="emby-button" type="button" class="raised" onclick="SportsDVR.testAlias()">
                                    <span>Lookup</span>
                                </button>
                            </div>
                        </div>
                        <div id="aliasTestResult" class="fieldDescription" style="display: none; padding: 1em; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 1em;"></div>
                        
                        <h3 style="margin-top: 1.5em;">Custom Aliases</h3>
                        <div id="customAliasesList"></div>
                        <div style="margin-top: 1em;">
                            <button is="emby-button" type="button" class="raised" onclick="SportsDVR.openAliasModal()">
                                <span>Add Custom Alias</span>
                            </button>
                        </div>
                    </fieldset>
                    
                    <!-- Subscriptions List -->
                    <fieldset class="verticalSection">
                        <legend>Your Subscriptions</legend>
                        <div id="subscriptionsList"></div>
                    </fieldset>
                    
                    <!-- Add/Edit Subscription -->
                    <fieldset class="verticalSection">
                        <legend id="subscriptionFormTitle">Add Subscription</legend>
                        <input type="hidden" id="editId">
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="subName">Name</label>
                            <input type="text" id="subName" placeholder="e.g., Lakers, UFC, Premier League" is="emby-input" required oninput="SportsDVR.updatePatternHint()">
                            <div class="fieldDescription">The team, league, or event name to subscribe to.</div>
                        </div>
                        
                        <div class="selectContainer">
                            <label class="selectLabel" for="subType">Type</label>
                            <select id="subType" is="emby-select" onchange="SportsDVR.updatePatternHint()">
                                <option value="0">Team (requires vs/@ in title)</option>
                                <option value="1">League (matches any program)</option>
                                <option value="2">Event Series (matches any program)</option>
                            </select>
                            <div class="fieldDescription">Team subscriptions only match games (vs/@). League/Event match any live program with the name.</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="subPattern">Match Pattern (optional)</label>
                            <input type="text" id="subPattern" placeholder="Leave blank to match by name" is="emby-input">
                            <div id="patternHint" class="fieldDescription">Leave blank to match any program containing the name. For custom matching, use text or regex: /pattern/i</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="subExclude">Exclude Patterns (optional)</label>
                            <input type="text" id="subExclude" placeholder="countdown, preview, press conference" is="emby-input">
                            <div class="fieldDescription">Comma-separated words. Programs containing these won't be recorded.</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="subPriority">Priority (1-100)</label>
                            <input type="number" id="subPriority" min="1" max="100" value="50" is="emby-input">
                            <div class="fieldDescription">Higher priority wins when games conflict.</div>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input type="checkbox" id="subReplays" is="emby-checkbox">
                                <span>Include replays/encores/classics</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">By default, only live/first-run programs are recorded.</div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5em; margin-top: 1em;">
                            <button is="emby-button" type="button" class="raised" onclick="SportsDVR.clearForm()">
                                <span>Clear</span>
                            </button>
                            <button is="emby-button" type="button" class="raised button-submit" onclick="SportsDVR.saveSubscription()">
                                <span>Save Subscription</span>
                            </button>
                        </div>
                    </fieldset>
                    
                </form>
            </div>
        </div>
        
        <script>
            const SportsDVR = {
                getApiUrl(path) {
                    return ApiClient.getUrl('SportsDVR' + (path ? '/' + path : ''));
                },
                
                initialized: false,
                
                async init() {
                    if (this.initialized) return;
                    this.initialized = true;
                    
                    await this.loadSettings();
                    await this.loadSubscriptions();
                    await this.loadStatus();
                    await this.loadCustomAliases();
                },
                
                async loadSettings() {
                    try {
                        const config = await ApiClient.getPluginConfiguration('a1b2c3d4-e5f6-7890-abcd-ef1234567890');
                        document.getElementById('maxConcurrent').value = config.MaxConcurrentRecordings || 2;
                        document.getElementById('defaultPriority').value = config.DefaultPriority || 50;
                        document.getElementById('scanInterval').value = config.ScanIntervalMinutes || 5;
                        document.getElementById('enableAutoScheduling').checked = config.EnableAutoScheduling !== false;
                        document.getElementById('enableAliasMatching').checked = config.EnableAliasMatching !== false;
                    } catch (e) {
                        console.error('Failed to load settings:', e);
                    }
                },
                
                async saveSettings() {
                    try {
                        const config = await ApiClient.getPluginConfiguration('a1b2c3d4-e5f6-7890-abcd-ef1234567890');
                        config.MaxConcurrentRecordings = parseInt(document.getElementById('maxConcurrent').value);
                        config.DefaultPriority = parseInt(document.getElementById('defaultPriority').value);
                        config.ScanIntervalMinutes = parseInt(document.getElementById('scanInterval').value);
                        config.EnableAutoScheduling = document.getElementById('enableAutoScheduling').checked;
                        config.EnableAliasMatching = document.getElementById('enableAliasMatching').checked;
                        
                        await ApiClient.updatePluginConfiguration('a1b2c3d4-e5f6-7890-abcd-ef1234567890', config);
                        Dashboard.alert('Settings saved!');
                    } catch (e) {
                        console.error('Failed to save settings:', e);
                        Dashboard.alert('Failed to save settings');
                    }
                },
                
                async loadStatus() {
                    try {
                        const status = await ApiClient.ajax({
                            url: this.getApiUrl('Status'),
                            type: 'GET',
                            dataType: 'json'
                        });
                        document.getElementById('statSubscriptions').textContent = status.TotalSubscriptions || 0;
                        document.getElementById('statEnabled').textContent = status.EnabledSubscriptions || 0;
                        document.getElementById('statConcurrent').textContent = status.MaxConcurrentRecordings || 2;
                    } catch (e) {
                        console.error('Failed to load status:', e);
                    }
                },
                
                async loadSubscriptions() {
                    const container = document.getElementById('subscriptionsList');
                    try {
                        const subscriptions = await ApiClient.ajax({
                            url: this.getApiUrl('Subscriptions'),
                            type: 'GET',
                            dataType: 'json'
                        });
                        
                        if (!subscriptions || subscriptions.length === 0) {
                            container.innerHTML = '<p class="fieldDescription">No subscriptions yet. Add one below.</p>';
                            return;
                        }
                        
                        let html = '<div class="paperList">';
                        subscriptions.forEach(sub => {
                            html += this.renderSubscription(sub);
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } catch (e) {
                        console.error('Failed to load subscriptions:', e);
                        container.innerHTML = '<p class="fieldDescription" style="color: #f44336;">Failed to load subscriptions</p>';
                    }
                },
                
                renderSubscription(sub) {
                    const typeNames = { 0: 'Team', 1: 'League', 2: 'Event', 'Team': 'Team', 'League': 'League', 'Event': 'Event' };
                    const typeName = typeNames[sub.type] || 'Unknown';
                    const disabledClass = sub.enabled ? '' : ' style="opacity: 0.5;"';
                    const enableText = sub.enabled ? 'Disable' : 'Enable';
                    
                    let badges = '';
                    if (sub.priority >= 70) badges += '<span style="background: rgba(76,175,80,0.3); padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 0.5em;">High Priority</span>';
                    if (sub.includeReplays) badges += '<span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 0.5em;">+Replays</span>';
                    
                    return '<div class="listItem listItem-border"' + disabledClass + '>' +
                        '<div class="listItemBody two-line">' +
                        '<div class="listItemBodyText">' + this.escapeHtml(sub.name) + badges + '</div>' +
                        '<div class="listItemBodyText secondary">' + typeName + ' · Pattern: ' + this.escapeHtml(sub.matchPattern || sub.name) + ' · Priority: ' + sub.priority + '</div>' +
                        '</div>' +
                        '<button is="emby-button" type="button" class="fab mini autoSize" onclick="SportsDVR.editSubscription(\'' + sub.id + '\')" title="Edit"><span class="material-icons">edit</span></button>' +
                        '<button is="emby-button" type="button" class="fab mini autoSize" onclick="SportsDVR.toggleSubscription(\'' + sub.id + '\', ' + (!sub.enabled) + ')" title="' + enableText + '"><span class="material-icons">' + (sub.enabled ? 'pause' : 'play_arrow') + '</span></button>' +
                        '<button is="emby-button" type="button" class="fab mini autoSize" onclick="SportsDVR.deleteSubscription(\'' + sub.id + '\')" title="Delete"><span class="material-icons">delete</span></button>' +
                        '</div>';
                },
                
                clearForm() {
                    document.getElementById('subscriptionFormTitle').textContent = 'Add Subscription';
                    document.getElementById('editId').value = '';
                    document.getElementById('subName').value = '';
                    document.getElementById('subType').value = '0';
                    document.getElementById('subPattern').value = '';
                    document.getElementById('subExclude').value = '';
                    document.getElementById('subPriority').value = document.getElementById('defaultPriority').value || '50';
                    document.getElementById('subReplays').checked = false;
                    this.updatePatternHint();
                },
                
                updatePatternHint() {
                    const name = document.getElementById('subName').value.trim();
                    const type = document.getElementById('subType').value;
                    const patternInput = document.getElementById('subPattern');
                    const hint = document.getElementById('patternHint');
                    
                    const typeNames = ['Team', 'League', 'Event'];
                    const typeName = typeNames[parseInt(type)] || 'subscription';
                    
                    if (name) {
                        patternInput.placeholder = 'Will match: ' + name.toLowerCase();
                        if (type === '0') {
                            hint.textContent = 'Leave blank to match "' + name + '" in game titles (with vs/@). Custom pattern overrides.';
                        } else {
                            hint.textContent = 'Leave blank to match any live program containing "' + name + '". Custom pattern overrides.';
                        }
                    } else {
                        patternInput.placeholder = 'Leave blank to match by name';
                        hint.textContent = 'Leave blank to match any program containing the name. For custom matching, use text or regex: /pattern/i';
                    }
                },
                
                async editSubscription(id) {
                    try {
                        const sub = await ApiClient.ajax({
                            url: this.getApiUrl('Subscriptions/' + id),
                            type: 'GET',
                            dataType: 'json'
                        });
                        
                        document.getElementById('subscriptionFormTitle').textContent = 'Edit Subscription';
                        document.getElementById('editId').value = sub.id;
                        document.getElementById('subName').value = sub.name;
                        
                        // Handle both integer and string enum values for type
                        let typeValue = sub.type;
                        if (typeof typeValue === 'string') {
                            const typeMap = { 'Team': '0', 'League': '1', 'Event': '2' };
                            typeValue = typeMap[typeValue] || '0';
                        }
                        document.getElementById('subType').value = typeValue;
                        
                        // Clear pattern if it's just the name lowercase (show as optional)
                        const pattern = sub.matchPattern || '';
                        document.getElementById('subPattern').value = (pattern === sub.name.toLowerCase()) ? '' : pattern;
                        document.getElementById('subExclude').value = (sub.excludePatterns || []).join(', ');
                        document.getElementById('subPriority').value = sub.priority;
                        document.getElementById('subReplays').checked = sub.includeReplays;
                        
                        this.updatePatternHint();
                        document.getElementById('subscriptionFormTitle').scrollIntoView({ behavior: 'smooth' });
                    } catch (e) {
                        console.error('Failed to load subscription:', e);
                        Dashboard.alert('Failed to load subscription');
                    }
                },
                
                async saveSubscription() {
                    const id = document.getElementById('editId').value;
                    const name = document.getElementById('subName').value.trim();
                    
                    if (!name) {
                        Dashboard.alert('Name is required');
                        return;
                    }
                    
                    const excludeText = document.getElementById('subExclude').value;
                    const excludePatterns = excludeText ? excludeText.split(',').map(s => s.trim()).filter(s => s) : [];
                    
                    const data = {
                        name: name,
                        type: parseInt(document.getElementById('subType').value),
                        matchPattern: document.getElementById('subPattern').value || name.toLowerCase(),
                        excludePatterns: excludePatterns,
                        priority: parseInt(document.getElementById('subPriority').value),
                        includeReplays: document.getElementById('subReplays').checked,
                        enabled: true
                    };
                    
                    try {
                        if (id) {
                            await ApiClient.ajax({
                                url: this.getApiUrl('Subscriptions/' + id),
                                type: 'PUT',
                                data: JSON.stringify(data),
                                contentType: 'application/json'
                            });
                        } else {
                            await ApiClient.ajax({
                                url: this.getApiUrl('Subscriptions'),
                                type: 'POST',
                                data: JSON.stringify(data),
                                contentType: 'application/json'
                            });
                        }
                        this.clearForm();
                        await this.loadSubscriptions();
                        await this.loadStatus();
                        Dashboard.alert('Subscription saved!');
                        document.getElementById('subscriptionsList').scrollIntoView({ behavior: 'smooth' });
                    } catch (e) {
                        console.error('Failed to save subscription:', e);
                        Dashboard.alert('Failed to save subscription');
                    }
                },
                
                async toggleSubscription(id, enabled) {
                    try {
                        await ApiClient.ajax({
                            url: this.getApiUrl('Subscriptions/' + id + '/Toggle?enabled=' + enabled),
                            type: 'POST'
                        });
                        await this.loadSubscriptions();
                        await this.loadStatus();
                    } catch (e) {
                        console.error('Failed to toggle subscription:', e);
                        Dashboard.alert('Failed to toggle subscription');
                    }
                },
                
                async deleteSubscription(id) {
                    if (!confirm('Are you sure you want to delete this subscription?')) return;
                    try {
                        await ApiClient.ajax({
                            url: this.getApiUrl('Subscriptions/' + id),
                            type: 'DELETE'
                        });
                        await this.loadSubscriptions();
                        await this.loadStatus();
                        Dashboard.alert('Subscription deleted');
                    } catch (e) {
                        console.error('Failed to delete subscription:', e);
                        Dashboard.alert('Failed to delete subscription');
                    }
                },
                
                async testAlias() {
                    const input = document.getElementById('aliasTestInput').value.trim();
                    if (!input) return;
                    
                    const resultDiv = document.getElementById('aliasTestResult');
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = 'Looking up...';
                    
                    try {
                        const data = await ApiClient.ajax({
                            url: this.getApiUrl('Aliases/' + encodeURIComponent(input)),
                            type: 'GET',
                            dataType: 'json'
                        });
                        
                        resultDiv.innerHTML = '<strong>Canonical Name:</strong> ' + this.escapeHtml(data.CanonicalName) + '<br>' +
                            '<strong>All Aliases:</strong> ' + data.Aliases.map(a => this.escapeHtml(a)).join(', ') + '<br>' +
                            '<strong>Pattern:</strong> <code style="font-size: 0.85em;">' + this.escapeHtml(data.SuggestedPattern) + '</code>';
                    } catch (e) {
                        console.error('Alias lookup failed:', e);
                        resultDiv.innerHTML = '<span style="color: #f44336;">Lookup failed</span>';
                    }
                },
                
                async loadCustomAliases() {
                    const container = document.getElementById('customAliasesList');
                    try {
                        const aliases = await ApiClient.ajax({
                            url: this.getApiUrl('Aliases/Custom'),
                            type: 'GET',
                            dataType: 'json'
                        }) || [];
                        
                        if (aliases.length === 0) {
                            container.innerHTML = '<p class="fieldDescription">No custom aliases defined.</p>';
                            return;
                        }
                        
                        let html = '<div class="paperList">';
                        aliases.forEach(alias => {
                            html += '<div class="listItem listItem-border">' +
                                '<div class="listItemBody">' +
                                '<div class="listItemBodyText"><strong>' + this.escapeHtml(alias.CanonicalName) + '</strong> = ' + alias.Aliases.map(a => this.escapeHtml(a)).join(', ') + '</div>' +
                                '</div>' +
                                '<button is="emby-button" type="button" class="fab mini autoSize" onclick="SportsDVR.deleteCustomAlias(\'' + this.escapeHtml(alias.CanonicalName) + '\')" title="Delete"><span class="material-icons">delete</span></button>' +
                                '</div>';
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } catch (e) {
                        console.error('Failed to load custom aliases:', e);
                        container.innerHTML = '<p class="fieldDescription" style="color: #f44336;">Failed to load aliases</p>';
                    }
                },
                
                openAliasModal() {
                    const html = '<div id="aliasModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
                        '<div style="background: #1c1c1e; border-radius: 8px; padding: 1.5em; max-width: 450px; width: 90%;">' +
                        '<h3 style="margin: 0 0 1em 0;">Add Custom Alias</h3>' +
                        '<div class="inputContainer">' +
                        '<label class="inputLabel" for="aliasCanonical">Canonical Name</label>' +
                        '<input type="text" id="aliasCanonical" placeholder="e.g., Manchester City" is="emby-input">' +
                        '<div class="fieldDescription">The official team name.</div>' +
                        '</div>' +
                        '<div class="inputContainer">' +
                        '<label class="inputLabel" for="aliasVariants">Aliases (comma-separated)</label>' +
                        '<input type="text" id="aliasVariants" placeholder="e.g., Man City, MCFC, Citizens" is="emby-input">' +
                        '<div class="fieldDescription">Alternative names that should match.</div>' +
                        '</div>' +
                        '<div style="display: flex; gap: 0.5em; justify-content: flex-end; margin-top: 1.5em;">' +
                        '<button is="emby-button" type="button" class="raised" onclick="SportsDVR.closeAliasModal()"><span>Cancel</span></button>' +
                        '<button is="emby-button" type="button" class="raised button-submit" onclick="SportsDVR.saveCustomAlias()"><span>Add Alias</span></button>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
                    document.body.insertAdjacentHTML('beforeend', html);
                },
                
                closeAliasModal() {
                    const modal = document.getElementById('aliasModal');
                    if (modal) modal.remove();
                },
                
                async saveCustomAlias() {
                    const canonical = document.getElementById('aliasCanonical').value.trim();
                    const variants = document.getElementById('aliasVariants').value.split(',').map(v => v.trim()).filter(v => v);
                    
                    if (!canonical || variants.length === 0) {
                        Dashboard.alert('Please fill in all fields');
                        return;
                    }
                    
                    try {
                        await ApiClient.ajax({
                            url: this.getApiUrl('Aliases/Custom'),
                            type: 'POST',
                            data: JSON.stringify({ CanonicalName: canonical, Aliases: variants }),
                            contentType: 'application/json'
                        });
                        this.closeAliasModal();
                        await this.loadCustomAliases();
                        Dashboard.alert('Alias added!');
                    } catch (e) {
                        console.error('Failed to add alias:', e);
                        Dashboard.alert('Failed to add alias');
                    }
                },
                
                async deleteCustomAlias(canonicalName) {
                    if (!confirm('Delete alias for "' + canonicalName + '"?')) return;
                    try {
                        await ApiClient.ajax({
                            url: this.getApiUrl('Aliases/Custom/' + encodeURIComponent(canonicalName)),
                            type: 'DELETE'
                        });
                        await this.loadCustomAliases();
                        Dashboard.alert('Alias deleted');
                    } catch (e) {
                        console.error('Failed to delete alias:', e);
                        Dashboard.alert('Failed to delete alias');
                    }
                },
                
                escapeHtml(text) {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
            };
            
            SportsDVR.init();
        </script>
    </div>
</body>
</html>

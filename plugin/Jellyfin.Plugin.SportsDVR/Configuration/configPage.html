<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Sports DVR</title>
</head>
<body>
    <div id="SportsDVRConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-select,emby-checkbox">
        
        <div data-role="content">
            <div class="content-primary">
                <h2>Sports DVR</h2>
                <p>Automatically record sports based on team, league, or event subscriptions.</p>
                
                <form id="SportsDVRConfigForm">
                    
                    <!-- Status Overview -->
                    <fieldset class="verticalSection">
                        <legend>Overview</legend>
                        <div style="display: flex; gap: 2em; flex-wrap: wrap;">
                            <div>
                                <span id="statSubscriptions" style="font-size: 1.5em; font-weight: bold;">0</span>
                                <div class="fieldDescription">Subscriptions</div>
                            </div>
                            <div>
                                <span id="statEnabled" style="font-size: 1.5em; font-weight: bold;">0</span>
                                <div class="fieldDescription">Active</div>
                            </div>
                            <div>
                                <span id="statConcurrent" style="font-size: 1.5em; font-weight: bold;">2</span>
                                <div class="fieldDescription">Max Streams</div>
                            </div>
                            <div>
                                <span id="statUpcoming" style="font-size: 1.5em; font-weight: bold; color: #4caf50;">0</span>
                                <div class="fieldDescription">Scheduled</div>
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Quick Actions -->
                    <fieldset class="verticalSection">
                        <legend>‚ö° Quick Actions</legend>
                        <div style="display: flex; gap: 1em; flex-wrap: wrap;">
                            <button is="emby-button" type="button" class="raised" onclick="SportsDVR.scanNow()" id="scanNowBtn">
                                <span class="material-icons" style="font-size: 1em; vertical-align: middle;">search</span>
                                <span style="vertical-align: middle;">Scan EPG Now</span>
                            </button>
                            <button is="emby-button" type="button" class="raised" onclick="SportsDVR.clearScheduleCache()" id="clearCacheBtn">
                                <span class="material-icons" style="font-size: 1em; vertical-align: middle;">delete_sweep</span>
                                <span style="vertical-align: middle;">Clear Schedule Cache</span>
                            </button>
                        </div>
                        <div class="fieldDescription" style="margin-top: 0.5em;">
                            <strong>Scan EPG Now:</strong> Immediately scan the guide for matching programs and schedule recordings.<br>
                            <strong>Clear Schedule Cache:</strong> Reset the plugin's internal tracking (use after changing tuner/EPG).
                        </div>
                        <div id="actionStatus" class="fieldDescription" style="margin-top: 0.5em; display: none;"></div>
                    </fieldset>
                    
                    <!-- Upcoming Recordings Dashboard -->
                    <fieldset class="verticalSection">
                        <legend>üì∫ Upcoming Recordings</legend>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
                            <div class="fieldDescription" id="upcomingSummary">Loading...</div>
                            <button is="emby-button" type="button" class="raised" onclick="SportsDVR.refreshUpcoming()" style="padding: 0.3em 0.8em;">
                                <span class="material-icons" style="font-size: 1em; vertical-align: middle;">refresh</span>
                                <span style="vertical-align: middle;">Refresh</span>
                            </button>
                        </div>
                        <div id="upcomingRecordingsList" style="max-height: 400px; overflow-y: auto;"></div>
                    </fieldset>
                    
                    <!-- Settings -->
                    <fieldset class="verticalSection">
                        <legend>Settings</legend>
                        <p class="fieldDescription">Recording paths and storage are managed by Jellyfin's DVR settings.</p>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="maxConcurrent">Max Concurrent Recordings</label>
                            <input type="number" id="maxConcurrent" min="1" max="10" value="2" is="emby-input">
                            <div class="fieldDescription">Number of tuners/streams available (e.g., 2 for most IPTV)</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="defaultPriority">Default Priority (1-100)</label>
                            <input type="number" id="defaultPriority" min="1" max="100" value="50" is="emby-input">
                            <div class="fieldDescription">Default priority for new subscriptions. Higher wins conflicts.</div>
                        </div>
                        
                        <div class="selectContainer">
                            <label class="selectLabel" for="primaryRegion">Primary Region</label>
                            <select id="primaryRegion" is="emby-select">
                                <option value="USA">üá∫üá∏ USA (12 PM - 12 AM EST)</option>
                                <option value="Europe">üá™üá∫ Europe (2 PM - 11 PM CET)</option>
                                <option value="Asia">üáØüáµ Asia/Pacific (6 PM - 12 AM JST)</option>
                                <option value="Australia">üá¶üá∫ Australia (5 PM - 12 AM AEST)</option>
                                <option value="All">üåç All Regions (No time filtering)</option>
                            </select>
                            <div class="fieldDescription">Time-based filtering for live games. Select your primary viewing region to filter out replays broadcast at unusual hours.</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="scanInterval">EPG Scan Interval (minutes)</label>
                            <input type="number" id="scanInterval" min="1" max="60" value="5" is="emby-input">
                            <div class="fieldDescription">How often to scan EPG for matching programs.</div>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input type="checkbox" id="enableAutoScheduling" is="emby-checkbox" checked>
                                <span>Enable automatic scheduling from EPG</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">Automatically schedule recordings when matching programs are found.</div>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input type="checkbox" id="enableAliasMatching" is="emby-checkbox" checked>
                                <span>Enable team alias matching</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">Match team name variations (e.g., "Man City" matches "Manchester City").</div>
                        </div>
                        
                    </fieldset>
                    
                    <!-- Team Aliases -->
                    <fieldset class="verticalSection">
                        <legend>Team Aliases</legend>
                        <p class="fieldDescription">Add custom team name variations. Built-in aliases include common variations.</p>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="aliasTestInput">Test Alias Lookup</label>
                            <div style="display: flex; gap: 0.5em;">
                                <input type="text" id="aliasTestInput" placeholder="Enter team name..." is="emby-input" style="flex: 1;">
                                <button is="emby-button" type="button" class="raised" onclick="SportsDVR.testAlias()">
                                    <span>Lookup</span>
                                </button>
                            </div>
                        </div>
                        <div id="aliasTestResult" class="fieldDescription" style="display: none; padding: 1em; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 1em;"></div>
                        
                        <h3 style="margin-top: 1.5em;">Custom Aliases</h3>
                        <div id="customAliasesList"></div>
                        <div style="margin-top: 1em;">
                            <button is="emby-button" type="button" class="raised" onclick="SportsDVR.openAliasModal()">
                                <span>Add Custom Alias</span>
                            </button>
                        </div>
                    </fieldset>
                    
                    <!-- Subscriptions List -->
                    <fieldset class="verticalSection">
                        <legend>Your Subscriptions</legend>
                        <div id="subscriptionsList"></div>
                    </fieldset>
                    
                    <!-- Add/Edit Subscription -->
                    <fieldset class="verticalSection">
                        <legend id="subscriptionFormTitle">Add Subscription</legend>
                        <input type="hidden" id="editId">
                        
                        <div class="selectContainer">
                            <label class="selectLabel" for="subType">Type</label>
                            <select id="subType" is="emby-select" onchange="SportsDVR.onTypeChange()">
                                <option value="0">Team (requires vs/@ in title)</option>
                                <option value="1">League (matches any program)</option>
                                <option value="2">Event Series (matches any program)</option>
                            </select>
                            <div class="fieldDescription">Team subscriptions only match games (vs/@). League/Event match any live program with the name.</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="subName">Name</label>
                            <input type="text" id="subName" placeholder="Type to search or enter custom..." is="emby-input" required oninput="SportsDVR.updatePatternHint()" list="teamsList" autocomplete="off">
                            <div id="nameHint" class="fieldDescription">Type to search teams or enter a custom team name.</div>
                        </div>
                        
                        <!-- Datalists for autocomplete -->
                        <datalist id="teamsList">
                            <!-- NBA -->
                            <option value="Los Angeles Lakers">NBA</option>
                            <option value="Los Angeles Clippers">NBA</option>
                            <option value="Golden State Warriors">NBA</option>
                            <option value="Boston Celtics">NBA</option>
                            <option value="Brooklyn Nets">NBA</option>
                            <option value="New York Knicks">NBA</option>
                            <option value="Philadelphia 76ers">NBA</option>
                            <option value="Miami Heat">NBA</option>
                            <option value="Chicago Bulls">NBA</option>
                            <option value="Dallas Mavericks">NBA</option>
                            <option value="Houston Rockets">NBA</option>
                            <option value="San Antonio Spurs">NBA</option>
                            <option value="Phoenix Suns">NBA</option>
                            <option value="Denver Nuggets">NBA</option>
                            <option value="Milwaukee Bucks">NBA</option>
                            <option value="Toronto Raptors">NBA</option>
                            <option value="Minnesota Timberwolves">NBA</option>
                            <option value="Oklahoma City Thunder">NBA</option>
                            <option value="Cleveland Cavaliers">NBA</option>
                            <!-- NFL -->
                            <option value="Kansas City Chiefs">NFL</option>
                            <option value="San Francisco 49ers">NFL</option>
                            <option value="Dallas Cowboys">NFL</option>
                            <option value="Philadelphia Eagles">NFL</option>
                            <option value="Buffalo Bills">NFL</option>
                            <option value="Miami Dolphins">NFL</option>
                            <option value="New England Patriots">NFL</option>
                            <option value="Green Bay Packers">NFL</option>
                            <option value="Baltimore Ravens">NFL</option>
                            <option value="Cincinnati Bengals">NFL</option>
                            <option value="Detroit Lions">NFL</option>
                            <!-- MLB -->
                            <option value="New York Yankees">MLB</option>
                            <option value="Los Angeles Dodgers">MLB</option>
                            <option value="Boston Red Sox">MLB</option>
                            <option value="Chicago Cubs">MLB</option>
                            <option value="Atlanta Braves">MLB</option>
                            <option value="Houston Astros">MLB</option>
                            <option value="Philadelphia Phillies">MLB</option>
                            <!-- NHL -->
                            <option value="Edmonton Oilers">NHL</option>
                            <option value="Florida Panthers">NHL</option>
                            <option value="New York Rangers">NHL</option>
                            <option value="Boston Bruins">NHL</option>
                            <option value="Toronto Maple Leafs">NHL</option>
                            <option value="Vegas Golden Knights">NHL</option>
                            <option value="Colorado Avalanche">NHL</option>
                            <!-- Premier League -->
                            <option value="Manchester City">Premier League</option>
                            <option value="Arsenal">Premier League</option>
                            <option value="Liverpool">Premier League</option>
                            <option value="Manchester United">Premier League</option>
                            <option value="Chelsea">Premier League</option>
                            <option value="Tottenham Hotspur">Premier League</option>
                            <option value="Newcastle United">Premier League</option>
                            <!-- La Liga -->
                            <option value="Real Madrid">La Liga</option>
                            <option value="Barcelona">La Liga</option>
                            <option value="Atletico Madrid">La Liga</option>
                            <!-- Serie A -->
                            <option value="Inter Milan">Serie A</option>
                            <option value="AC Milan">Serie A</option>
                            <option value="Juventus">Serie A</option>
                            <option value="Napoli">Serie A</option>
                            <!-- Bundesliga -->
                            <option value="Bayern Munich">Bundesliga</option>
                            <option value="Borussia Dortmund">Bundesliga</option>
                            <!-- Ligue 1 -->
                            <option value="Paris Saint-Germain">Ligue 1</option>
                        </datalist>
                        
                        <datalist id="leaguesList">
                            <!-- US Pro Leagues -->
                            <option value="NBA">US - Basketball</option>
                            <option value="NFL">US - Football</option>
                            <option value="MLB">US - Baseball</option>
                            <option value="NHL">US - Hockey</option>
                            <option value="MLS">US - Soccer</option>
                            <option value="WNBA">US - Women's Basketball</option>
                            <option value="NWSL">US - Women's Soccer</option>
                            <!-- US College -->
                            <option value="NCAA Basketball">US College</option>
                            <option value="NCAA Football">US College</option>
                            <option value="March Madness">US College</option>
                            <option value="College Football">US College</option>
                            <!-- European Soccer - Top 5 -->
                            <option value="Premier League">England</option>
                            <option value="La Liga">Spain</option>
                            <option value="Serie A">Italy</option>
                            <option value="Bundesliga">Germany</option>
                            <option value="Ligue 1">France</option>
                            <!-- European Competitions -->
                            <option value="Champions League">UEFA</option>
                            <option value="Europa League">UEFA</option>
                            <option value="Conference League">UEFA</option>
                            <!-- International Soccer -->
                            <option value="World Cup">International</option>
                            <option value="Euro">International</option>
                            <option value="Copa America">International</option>
                            <option value="Nations League">International</option>
                            <option value="CONCACAF">International</option>
                            <!-- Other European -->
                            <option value="Eredivisie">Netherlands</option>
                            <option value="Liga Portugal">Portugal</option>
                            <option value="Scottish Premiership">Scotland</option>
                            <option value="Super Lig">Turkey</option>
                            <!-- South American -->
                            <option value="Brasileirao">Brazil</option>
                            <option value="Liga MX">Mexico</option>
                            <option value="Argentine Primera">Argentina</option>
                            <!-- Other Sports Leagues -->
                            <option value="Formula 1">Motorsport</option>
                            <option value="NASCAR">Motorsport</option>
                            <option value="IndyCar">Motorsport</option>
                            <option value="PGA Tour">Golf</option>
                            <option value="ATP Tour">Tennis</option>
                            <option value="WTA Tour">Tennis</option>
                        </datalist>
                        
                        <datalist id="eventsList">
                            <!-- Combat Sports -->
                            <option value="UFC">MMA</option>
                            <option value="Bellator">MMA</option>
                            <option value="PFL">MMA</option>
                            <option value="Boxing">Combat Sports</option>
                            <option value="WWE">Wrestling</option>
                            <option value="AEW">Wrestling</option>
                            <!-- Major Events -->
                            <option value="Super Bowl">NFL</option>
                            <option value="NBA Finals">NBA</option>
                            <option value="World Series">MLB</option>
                            <option value="Stanley Cup">NHL</option>
                            <option value="NBA Playoffs">NBA</option>
                            <option value="NFL Playoffs">NFL</option>
                            <!-- Motorsport Events -->
                            <option value="F1 Grand Prix">Formula 1</option>
                            <option value="Daytona 500">NASCAR</option>
                            <option value="Indy 500">IndyCar</option>
                            <option value="Le Mans">Endurance</option>
                            <!-- Golf Majors -->
                            <option value="Masters">Golf</option>
                            <option value="US Open Golf">Golf</option>
                            <option value="The Open Championship">Golf</option>
                            <option value="PGA Championship">Golf</option>
                            <option value="Ryder Cup">Golf</option>
                            <!-- Tennis Majors -->
                            <option value="Wimbledon">Tennis</option>
                            <option value="US Open Tennis">Tennis</option>
                            <option value="French Open">Tennis</option>
                            <option value="Australian Open">Tennis</option>
                            <!-- Other Major Events -->
                            <option value="Olympics">Multi-sport</option>
                            <option value="Winter Olympics">Multi-sport</option>
                            <option value="Kentucky Derby">Horse Racing</option>
                            <option value="Triple Crown">Horse Racing</option>
                            <option value="X Games">Action Sports</option>
                        </datalist>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="subPattern">Match Pattern (optional)</label>
                            <input type="text" id="subPattern" placeholder="Leave blank to match by name" is="emby-input">
                            <div id="patternHint" class="fieldDescription">Leave blank to match any program containing the name. For custom matching, use text or regex: /pattern/i</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="subExclude">Exclude Patterns (optional)</label>
                            <input type="text" id="subExclude" placeholder="countdown, preview, press conference" is="emby-input">
                            <div class="fieldDescription">Comma-separated words. Programs containing these won't be recorded.</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="subPriority">Priority (1-100)</label>
                            <input type="number" id="subPriority" min="1" max="100" value="50" is="emby-input">
                            <div class="fieldDescription">Higher priority wins when games conflict.</div>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input type="checkbox" id="subReplays" is="emby-checkbox">
                                <span>Include replays/encores/classics</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">By default, only live/first-run programs are recorded.</div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5em; margin-top: 1em;">
                            <button is="emby-button" type="button" class="raised" onclick="SportsDVR.clearForm()">
                                <span>Clear</span>
                            </button>
                            <button is="emby-button" type="button" class="raised button-submit" onclick="SportsDVR.saveSubscription()">
                                <span>Save Subscription</span>
                            </button>
                        </div>
                    </fieldset>
                    
                    <!-- Save Settings -->
                    <div style="margin-top: 1.5em;">
                        <button is="emby-button" type="button" class="raised button-submit block" onclick="SportsDVR.saveSettings()" style="padding: 0.8em 1.5em; font-size: 1.1em;">
                            <span class="material-icons" style="font-size: 1em; vertical-align: middle; margin-right: 0.3em;">save</span>
                            <span style="vertical-align: middle;">Save Settings</span>
                        </button>
                    </div>
                    
                </form>
            </div>
        </div>
        
        <script>
            // Use IIFE to avoid redeclaration errors when page reloads
            (function() {
                // Skip if already initialized on this page load
                if (window._sportsDvrInitialized) return;
                window._sportsDvrInitialized = true;
                
                window.SportsDVR = {
                    getApiUrl(path) {
                        return ApiClient.getUrl('SportsDVR' + (path ? '/' + path : ''));
                    },
                    
                    initialized: false,
                    
                    async init() {
                        if (this.initialized) return;
                        this.initialized = true;
                        
                        await this.loadSettings();
                        await this.loadSubscriptions();
                        await this.loadStatus();
                        await this.loadCustomAliases();
                        await this.loadUpcomingRecordings();
                        
                        // Auto-refresh upcoming every 5 minutes
                        setInterval(() => this.loadUpcomingRecordings(), 5 * 60 * 1000);
                    },
                
                async loadSettings() {
                    try {
                        const config = await ApiClient.getPluginConfiguration('a1b2c3d4-e5f6-7890-abcd-ef1234567890');
                        document.getElementById('maxConcurrent').value = config.MaxConcurrentRecordings || 2;
                        document.getElementById('defaultPriority').value = config.DefaultPriority || 50;
                        document.getElementById('primaryRegion').value = config.PrimaryRegion || 'USA';
                        document.getElementById('scanInterval').value = config.ScanIntervalMinutes || 5;
                        document.getElementById('enableAutoScheduling').checked = config.EnableAutoScheduling !== false;
                        document.getElementById('enableAliasMatching').checked = config.EnableAliasMatching !== false;
                    } catch (e) {
                        console.error('Failed to load settings:', e);
                    }
                },
                
                async saveSettings() {
                    try {
                        const config = await ApiClient.getPluginConfiguration('a1b2c3d4-e5f6-7890-abcd-ef1234567890');
                        config.MaxConcurrentRecordings = parseInt(document.getElementById('maxConcurrent').value);
                        config.DefaultPriority = parseInt(document.getElementById('defaultPriority').value);
                        config.PrimaryRegion = document.getElementById('primaryRegion').value || 'USA';
                        config.ScanIntervalMinutes = parseInt(document.getElementById('scanInterval').value);
                        config.EnableAutoScheduling = document.getElementById('enableAutoScheduling').checked;
                        config.EnableAliasMatching = document.getElementById('enableAliasMatching').checked;
                        
                        await ApiClient.updatePluginConfiguration('a1b2c3d4-e5f6-7890-abcd-ef1234567890', config);
                        Dashboard.alert('Settings saved!');
                    } catch (e) {
                        console.error('Failed to save settings:', e);
                        Dashboard.alert('Failed to save settings');
                    }
                },
                
                async loadStatus() {
                    try {
                        const status = await ApiClient.ajax({
                            url: this.getApiUrl('Status'),
                            type: 'GET',
                            dataType: 'json'
                        });
                        document.getElementById('statSubscriptions').textContent = status.TotalSubscriptions || 0;
                        document.getElementById('statEnabled').textContent = status.EnabledSubscriptions || 0;
                        document.getElementById('statConcurrent').textContent = status.MaxConcurrentRecordings || 2;
                    } catch (e) {
                        console.error('Failed to load status:', e);
                    }
                },
                
                async loadSubscriptions() {
                    const container = document.getElementById('subscriptionsList');
                    try {
                        const subscriptions = await ApiClient.ajax({
                            url: this.getApiUrl('Subscriptions'),
                            type: 'GET',
                            dataType: 'json'
                        });
                        
                        if (!subscriptions || subscriptions.length === 0) {
                            container.innerHTML = '<p class="fieldDescription">No subscriptions yet. Add one below.</p>';
                            return;
                        }
                        
                        let html = '<div class="paperList">';
                        subscriptions.forEach(sub => {
                            html += this.renderSubscription(sub);
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } catch (e) {
                        console.error('Failed to load subscriptions:', e);
                        container.innerHTML = '<p class="fieldDescription" style="color: #f44336;">Failed to load subscriptions</p>';
                    }
                },
                
                renderSubscription(sub) {
                    const typeNames = { 0: 'Team', 1: 'League', 2: 'Event', 'Team': 'Team', 'League': 'League', 'Event': 'Event' };
                    const typeName = typeNames[sub.type] || 'Unknown';
                    const disabledClass = sub.enabled ? '' : ' style="opacity: 0.5;"';
                    const enableText = sub.enabled ? 'Disable' : 'Enable';
                    
                    let badges = '';
                    if (sub.priority >= 70) badges += '<span style="background: rgba(76,175,80,0.3); padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 0.5em;">High Priority</span>';
                    if (sub.includeReplays) badges += '<span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 0.5em;">+Replays</span>';
                    
                    return '<div class="listItem listItem-border"' + disabledClass + '>' +
                        '<div class="listItemBody two-line">' +
                        '<div class="listItemBodyText">' + this.escapeHtml(sub.name) + badges + '</div>' +
                        '<div class="listItemBodyText secondary">' + typeName + ' ¬∑ Pattern: ' + this.escapeHtml(sub.matchPattern || sub.name) + ' ¬∑ Priority: ' + sub.priority + '</div>' +
                        '</div>' +
                        '<button is="emby-button" type="button" class="fab mini autoSize" onclick="SportsDVR.editSubscription(\'' + sub.id + '\')" title="Edit"><span class="material-icons">edit</span></button>' +
                        '<button is="emby-button" type="button" class="fab mini autoSize" onclick="SportsDVR.toggleSubscription(\'' + sub.id + '\', ' + (!sub.enabled) + ')" title="' + enableText + '"><span class="material-icons">' + (sub.enabled ? 'pause' : 'play_arrow') + '</span></button>' +
                        '<button is="emby-button" type="button" class="fab mini autoSize" onclick="SportsDVR.deleteSubscription(\'' + sub.id + '\')" title="Delete"><span class="material-icons">delete</span></button>' +
                        '</div>';
                },
                
                clearForm() {
                    document.getElementById('subscriptionFormTitle').textContent = 'Add Subscription';
                    document.getElementById('editId').value = '';
                    document.getElementById('subName').value = '';
                    document.getElementById('subType').value = '0';
                    document.getElementById('subPattern').value = '';
                    document.getElementById('subExclude').value = '';
                    document.getElementById('subPriority').value = document.getElementById('defaultPriority').value || '50';
                    document.getElementById('subReplays').checked = false;
                    this.onTypeChange();
                },
                
                onTypeChange() {
                    const type = document.getElementById('subType').value;
                    const nameInput = document.getElementById('subName');
                    const nameHint = document.getElementById('nameHint');
                    
                    // Switch datalist based on type
                    const datalists = { '0': 'teamsList', '1': 'leaguesList', '2': 'eventsList' };
                    const hints = {
                        '0': 'Type to search teams or enter a custom team name.',
                        '1': 'Select a league or type a custom league name.',
                        '2': 'Select an event series or type a custom event name.'
                    };
                    const placeholders = {
                        '0': 'Type to search teams...',
                        '1': 'Select or type a league...',
                        '2': 'Select or type an event...'
                    };
                    
                    nameInput.setAttribute('list', datalists[type] || 'teamsList');
                    nameInput.placeholder = placeholders[type] || placeholders['0'];
                    nameHint.textContent = hints[type] || hints['0'];
                    
                    this.updatePatternHint();
                },
                
                updatePatternHint() {
                    const name = document.getElementById('subName').value.trim();
                    const type = document.getElementById('subType').value;
                    const patternInput = document.getElementById('subPattern');
                    const hint = document.getElementById('patternHint');
                    
                    if (name) {
                        patternInput.placeholder = 'Will match: ' + name.toLowerCase();
                        if (type === '0') {
                            hint.textContent = 'Leave blank to match "' + name + '" in game titles (with vs/@). Custom pattern overrides.';
                        } else {
                            hint.textContent = 'Leave blank to match any live program containing "' + name + '". Custom pattern overrides.';
                        }
                    } else {
                        patternInput.placeholder = 'Leave blank to match by name';
                        hint.textContent = 'Leave blank to match any program containing the name. For custom matching, use text or regex: /pattern/i';
                    }
                },
                
                async editSubscription(id) {
                    try {
                        const sub = await ApiClient.ajax({
                            url: this.getApiUrl('Subscriptions/' + id),
                            type: 'GET',
                            dataType: 'json'
                        });
                        
                        document.getElementById('subscriptionFormTitle').textContent = 'Edit Subscription';
                        document.getElementById('editId').value = sub.id;
                        document.getElementById('subName').value = sub.name;
                        
                        // Handle both integer and string enum values for type
                        let typeValue = sub.type;
                        if (typeof typeValue === 'string') {
                            const typeMap = { 'Team': '0', 'League': '1', 'Event': '2' };
                            typeValue = typeMap[typeValue] || '0';
                        }
                        document.getElementById('subType').value = typeValue;
                        
                        // Clear pattern if it's just the name lowercase (show as optional)
                        const pattern = sub.matchPattern || '';
                        document.getElementById('subPattern').value = (pattern === sub.name.toLowerCase()) ? '' : pattern;
                        document.getElementById('subExclude').value = (sub.excludePatterns || []).join(', ');
                        document.getElementById('subPriority').value = sub.priority;
                        document.getElementById('subReplays').checked = sub.includeReplays;
                        
                        this.onTypeChange();
                        document.getElementById('subscriptionFormTitle').scrollIntoView({ behavior: 'smooth' });
                    } catch (e) {
                        console.error('Failed to load subscription:', e);
                        Dashboard.alert('Failed to load subscription');
                    }
                },
                
                async saveSubscription() {
                    const id = document.getElementById('editId').value;
                    const name = document.getElementById('subName').value.trim();
                    
                    if (!name) {
                        Dashboard.alert('Name is required');
                        return;
                    }
                    
                    const excludeText = document.getElementById('subExclude').value;
                    const excludePatterns = excludeText ? excludeText.split(',').map(s => s.trim()).filter(s => s) : [];
                    
                    const data = {
                        name: name,
                        type: parseInt(document.getElementById('subType').value),
                        matchPattern: document.getElementById('subPattern').value || name.toLowerCase(),
                        excludePatterns: excludePatterns,
                        priority: parseInt(document.getElementById('subPriority').value),
                        includeReplays: document.getElementById('subReplays').checked,
                        enabled: true
                    };
                    
                    try {
                        if (id) {
                            await ApiClient.ajax({
                                url: this.getApiUrl('Subscriptions/' + id),
                                type: 'PUT',
                                data: JSON.stringify(data),
                                contentType: 'application/json'
                            });
                        } else {
                            await ApiClient.ajax({
                                url: this.getApiUrl('Subscriptions'),
                                type: 'POST',
                                data: JSON.stringify(data),
                                contentType: 'application/json'
                            });
                        }
                        this.clearForm();
                        await this.loadSubscriptions();
                        await this.loadStatus();
                        Dashboard.alert('Subscription saved!');
                        document.getElementById('subscriptionsList').scrollIntoView({ behavior: 'smooth' });
                    } catch (e) {
                        console.error('Failed to save subscription:', e);
                        Dashboard.alert('Failed to save subscription');
                    }
                },
                
                async toggleSubscription(id, enabled) {
                    try {
                        await ApiClient.ajax({
                            url: this.getApiUrl('Subscriptions/' + id + '/Toggle?enabled=' + enabled),
                            type: 'POST'
                        });
                        await this.loadSubscriptions();
                        await this.loadStatus();
                    } catch (e) {
                        console.error('Failed to toggle subscription:', e);
                        Dashboard.alert('Failed to toggle subscription');
                    }
                },
                
                async deleteSubscription(id) {
                    if (!confirm('Are you sure you want to delete this subscription?')) return;
                    try {
                        await ApiClient.ajax({
                            url: this.getApiUrl('Subscriptions/' + id),
                            type: 'DELETE'
                        });
                        await this.loadSubscriptions();
                        await this.loadStatus();
                        Dashboard.alert('Subscription deleted');
                    } catch (e) {
                        console.error('Failed to delete subscription:', e);
                        Dashboard.alert('Failed to delete subscription');
                    }
                },
                
                async testAlias() {
                    const input = document.getElementById('aliasTestInput').value.trim();
                    if (!input) return;
                    
                    const resultDiv = document.getElementById('aliasTestResult');
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = 'Looking up...';
                    
                    try {
                        const data = await ApiClient.ajax({
                            url: this.getApiUrl('Aliases/' + encodeURIComponent(input)),
                            type: 'GET',
                            dataType: 'json'
                        });
                        
                        resultDiv.innerHTML = '<strong>Canonical Name:</strong> ' + this.escapeHtml(data.CanonicalName) + '<br>' +
                            '<strong>All Aliases:</strong> ' + data.Aliases.map(a => this.escapeHtml(a)).join(', ') + '<br>' +
                            '<strong>Pattern:</strong> <code style="font-size: 0.85em;">' + this.escapeHtml(data.SuggestedPattern) + '</code>';
                    } catch (e) {
                        console.error('Alias lookup failed:', e);
                        resultDiv.innerHTML = '<span style="color: #f44336;">Lookup failed</span>';
                    }
                },
                
                async loadCustomAliases() {
                    const container = document.getElementById('customAliasesList');
                    try {
                        const aliases = await ApiClient.ajax({
                            url: this.getApiUrl('Aliases/Custom'),
                            type: 'GET',
                            dataType: 'json'
                        }) || [];
                        
                        if (aliases.length === 0) {
                            container.innerHTML = '<p class="fieldDescription">No custom aliases defined.</p>';
                            return;
                        }
                        
                        let html = '<div class="paperList">';
                        aliases.forEach(alias => {
                            html += '<div class="listItem listItem-border">' +
                                '<div class="listItemBody">' +
                                '<div class="listItemBodyText"><strong>' + this.escapeHtml(alias.CanonicalName) + '</strong> = ' + alias.Aliases.map(a => this.escapeHtml(a)).join(', ') + '</div>' +
                                '</div>' +
                                '<button is="emby-button" type="button" class="fab mini autoSize" onclick="SportsDVR.deleteCustomAlias(\'' + this.escapeHtml(alias.CanonicalName) + '\')" title="Delete"><span class="material-icons">delete</span></button>' +
                                '</div>';
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } catch (e) {
                        console.error('Failed to load custom aliases:', e);
                        container.innerHTML = '<p class="fieldDescription" style="color: #f44336;">Failed to load aliases</p>';
                    }
                },
                
                openAliasModal() {
                    const html = '<div id="aliasModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
                        '<div style="background: #1c1c1e; border-radius: 8px; padding: 1.5em; max-width: 450px; width: 90%;">' +
                        '<h3 style="margin: 0 0 1em 0;">Add Custom Alias</h3>' +
                        '<div class="inputContainer">' +
                        '<label class="inputLabel" for="aliasCanonical">Canonical Name</label>' +
                        '<input type="text" id="aliasCanonical" placeholder="e.g., Manchester City" is="emby-input">' +
                        '<div class="fieldDescription">The official team name.</div>' +
                        '</div>' +
                        '<div class="inputContainer">' +
                        '<label class="inputLabel" for="aliasVariants">Aliases (comma-separated)</label>' +
                        '<input type="text" id="aliasVariants" placeholder="e.g., Man City, MCFC, Citizens" is="emby-input">' +
                        '<div class="fieldDescription">Alternative names that should match.</div>' +
                        '</div>' +
                        '<div style="display: flex; gap: 0.5em; justify-content: flex-end; margin-top: 1.5em;">' +
                        '<button is="emby-button" type="button" class="raised" onclick="SportsDVR.closeAliasModal()"><span>Cancel</span></button>' +
                        '<button is="emby-button" type="button" class="raised button-submit" onclick="SportsDVR.saveCustomAlias()"><span>Add Alias</span></button>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
                    document.body.insertAdjacentHTML('beforeend', html);
                },
                
                closeAliasModal() {
                    const modal = document.getElementById('aliasModal');
                    if (modal) modal.remove();
                },
                
                async saveCustomAlias() {
                    const canonical = document.getElementById('aliasCanonical').value.trim();
                    const variants = document.getElementById('aliasVariants').value.split(',').map(v => v.trim()).filter(v => v);
                    
                    if (!canonical || variants.length === 0) {
                        Dashboard.alert('Please fill in all fields');
                        return;
                    }
                    
                    try {
                        await ApiClient.ajax({
                            url: this.getApiUrl('Aliases/Custom'),
                            type: 'POST',
                            data: JSON.stringify({ CanonicalName: canonical, Aliases: variants }),
                            contentType: 'application/json'
                        });
                        this.closeAliasModal();
                        await this.loadCustomAliases();
                        Dashboard.alert('Alias added!');
                    } catch (e) {
                        console.error('Failed to add alias:', e);
                        Dashboard.alert('Failed to add alias');
                    }
                },
                
                async deleteCustomAlias(canonicalName) {
                    if (!confirm('Delete alias for "' + canonicalName + '"?')) return;
                    try {
                        await ApiClient.ajax({
                            url: this.getApiUrl('Aliases/Custom/' + encodeURIComponent(canonicalName)),
                            type: 'DELETE'
                        });
                        await this.loadCustomAliases();
                        Dashboard.alert('Alias deleted');
                    } catch (e) {
                        console.error('Failed to delete alias:', e);
                        Dashboard.alert('Failed to delete alias');
                    }
                },
                
                escapeHtml(text) {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },
                
                async refreshUpcoming() {
                    await this.loadUpcomingRecordings();
                },
                
                async scanNow() {
                    const btn = document.getElementById('scanNowBtn');
                    const status = document.getElementById('actionStatus');
                    
                    btn.disabled = true;
                    btn.innerHTML = '<span class="material-icons" style="font-size: 1em; vertical-align: middle;">hourglass_empty</span> <span style="vertical-align: middle;">Scanning...</span>';
                    status.style.display = 'block';
                    status.textContent = 'Scanning EPG for matching programs...';
                    status.style.color = '#2196f3';
                    
                    try {
                        const result = await ApiClient.ajax({
                            url: this.getApiUrl('Schedule/ScanNow'),
                            type: 'POST',
                            dataType: 'json'
                        });
                        
                        status.style.color = '#4caf50';
                        var parts = ['‚úÖ Scan complete!'];
                        parts.push('Found ' + (result.MatchesFound || 0) + ' matches.');
                        if ((result.NewRecordings || 0) > 0) {
                            parts.push(result.NewRecordings + ' new recordings scheduled.');
                        }
                        if ((result.AlreadyScheduled || 0) > 0) {
                            parts.push(result.AlreadyScheduled + ' already scheduled.');
                        }
                        if ((result.MatchesFound || 0) === 0 && (result.NewRecordings || 0) === 0 && (result.AlreadyScheduled || 0) === 0) {
                            parts.push('No matching programs found.');
                        }
                        parts.push('Total upcoming: ' + (result.TotalUpcoming || 0) + '.');
                        status.innerHTML = parts.join(' ');
                        
                        // Refresh the upcoming list
                        await this.loadUpcomingRecordings();
                    } catch (e) {
                        console.error('Scan failed:', e);
                        status.style.color = '#f44336';
                        status.textContent = '‚ùå Scan failed: ' + (e.message || 'Unknown error');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = '<span class="material-icons" style="font-size: 1em; vertical-align: middle;">search</span> <span style="vertical-align: middle;">Scan EPG Now</span>';
                    }
                },
                
                async clearScheduleCache() {
                    if (!confirm('This will clear the plugin\'s internal schedule tracking. Use this after changing your tuner or EPG source. Continue?')) {
                        return;
                    }
                    
                    const btn = document.getElementById('clearCacheBtn');
                    const status = document.getElementById('actionStatus');
                    
                    btn.disabled = true;
                    btn.innerHTML = '<span class="material-icons" style="font-size: 1em; vertical-align: middle;">hourglass_empty</span> <span style="vertical-align: middle;">Clearing...</span>';
                    status.style.display = 'block';
                    status.textContent = 'Clearing schedule cache...';
                    status.style.color = '#2196f3';
                    
                    try {
                        await ApiClient.ajax({
                            url: this.getApiUrl('Schedule/ClearCache'),
                            type: 'POST'
                        });
                        
                        status.style.color = '#4caf50';
                        status.innerHTML = '‚úÖ Cache cleared! The plugin will rescan the EPG on the next interval or click "Scan EPG Now".';
                        
                        // Reset the upcoming list
                        document.getElementById('upcomingRecordingsList').innerHTML = '<p class="fieldDescription">Cache cleared. Click "Scan EPG Now" to find games.</p>';
                        document.getElementById('statUpcoming').textContent = '0';
                    } catch (e) {
                        console.error('Clear cache failed:', e);
                        status.style.color = '#f44336';
                        status.textContent = '‚ùå Clear failed: ' + (e.message || 'Unknown error');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = '<span class="material-icons" style="font-size: 1em; vertical-align: middle;">delete_sweep</span> <span style="vertical-align: middle;">Clear Schedule Cache</span>';
                    }
                },
                
                async loadUpcomingRecordings() {
                    const container = document.getElementById('upcomingRecordingsList');
                    const summary = document.getElementById('upcomingSummary');
                    const statUpcoming = document.getElementById('statUpcoming');
                    
                    try {
                        const data = await ApiClient.ajax({
                            url: this.getApiUrl('Schedule/Upcoming'),
                            type: 'GET',
                            dataType: 'json'
                        });
                        
                        // Update stat counter
                        statUpcoming.textContent = data.TotalScheduled || 0;
                        
                        // Build summary line
                        if (data.SummaryByDate && Object.keys(data.SummaryByDate).length > 0) {
                            const summaryParts = Object.entries(data.SummaryByDate)
                                .map(([date, count]) => date + ': ' + count)
                                .join(' | ');
                            summary.textContent = summaryParts;
                        } else {
                            summary.textContent = 'No upcoming recordings';
                        }
                        
                        // Render list
                        if (!data.Scheduled || data.Scheduled.length === 0) {
                            container.innerHTML = '<p class="fieldDescription">No upcoming games scheduled.</p>';
                            return;
                        }
                        
                        let html = '<div class="paperList">';
                        let currentDate = '';
                        
                        data.Scheduled.forEach(rec => {
                            const startDate = new Date(rec.StartTime);
                            const dateStr = startDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                            const timeStr = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                            
                            // Add date header if new date
                            if (dateStr !== currentDate) {
                                currentDate = dateStr;
                                html += '<div style="background: rgba(255,255,255,0.1); padding: 0.5em 1em; font-weight: bold; margin-top: 0.5em;">' + dateStr + '</div>';
                            }
                            
                            // Determine badge color by league
                            const leagueColors = {
                                'NBA': '#c9082a',
                                'NFL': '#013369',
                                'MLB': '#002d72',
                                'NHL': '#000000',
                                'EPL': '#3d195b',
                                'SerieA': '#008fd7',
                                'LaLiga': '#ee8707',
                                'Champions League': '#1a1a2e',
                                'UFC': '#c9082a'
                            };
                            const badgeColor = leagueColors[rec.League] || 'rgba(255,255,255,0.2)';
                            
                            // Build title
                            let title = rec.CleanTitle || rec.Title || 'Unknown';
                            if (rec.Team1 && rec.Team2 && !title.includes('vs')) {
                                title = rec.Team1 + ' vs ' + rec.Team2;
                            }
                            
                            html += '<div class="listItem listItem-border">' +
                                '<div style="width: 60px; text-align: center; color: #888; font-size: 0.9em;">' + timeStr + '</div>' +
                                '<div class="listItemBody two-line" style="flex: 1;">' +
                                '<div class="listItemBodyText">' + this.escapeHtml(title) + '</div>' +
                                '<div class="listItemBodyText secondary">' +
                                '<span style="background: ' + badgeColor + '; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-right: 0.5em;">' + this.escapeHtml(rec.League || 'Sports') + '</span>' +
                                this.escapeHtml(rec.ChannelName) +
                                (rec.SubscriptionName ? ' ¬∑ ' + this.escapeHtml(rec.SubscriptionName) : '') +
                                (rec.HasBackupChannels ? ' <span style="color: #4caf50;" title="Backup channels available">‚óè</span>' : '') +
                                '</div>' +
                                '</div>' +
                                '</div>';
                        });
                        
                        html += '</div>';
                        container.innerHTML = html;
                        
                    } catch (e) {
                        console.error('Failed to load upcoming recordings:', e);
                        summary.textContent = 'Failed to load';
                        container.innerHTML = '<p class="fieldDescription" style="color: #f44336;">Failed to load upcoming recordings. Make sure the plugin is installed and Live TV is configured.</p>';
                        statUpcoming.textContent = '?';
                    }
                }
                };
                
                // Initialize
                SportsDVR.init();
            })();
        </script>
    </div>
</body>
</html>

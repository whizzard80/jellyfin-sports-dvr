<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Sports Library</title>
</head>
<body>
    <div id="SportsDVRLibraryPage" data-role="page" class="page type-interior"
         data-require="emby-button,paperList,listItem">
        
        <div data-role="content">
            <div class="content-primary">
                <h2>Sports Recordings</h2>
                <p>Browse your recorded sports games organized by date.</p>
                
                <div id="loadingIndicator" style="text-align: center; padding: 2em;">
                    <span>Loading recordings...</span>
                </div>
                
                <div id="recordingsContent" style="display: none;">
                    <!-- Today -->
                    <fieldset class="verticalSection" id="todaySection" style="display: none;">
                        <legend>Today</legend>
                        <div id="todayRecordings" class="paperList"></div>
                    </fieldset>
                    
                    <!-- This Week -->
                    <fieldset class="verticalSection" id="weekSection" style="display: none;">
                        <legend>This Week</legend>
                        <div id="weekRecordings" class="paperList"></div>
                    </fieldset>
                    
                    <!-- This Month -->
                    <fieldset class="verticalSection" id="monthSection" style="display: none;">
                        <legend>This Month</legend>
                        <div id="monthRecordings" class="paperList"></div>
                    </fieldset>
                    
                    <!-- Older -->
                    <fieldset class="verticalSection" id="olderSection" style="display: none;">
                        <legend>Older</legend>
                        <div id="olderRecordings" class="paperList"></div>
                    </fieldset>
                </div>
                
                <div id="emptyState" style="display: none; text-align: center; padding: 3em;">
                    <p class="fieldDescription">No sports recordings found.</p>
                    <p class="fieldDescription">Recordings will appear here once they're organized into the Sports DVR library.</p>
                </div>
            </div>
        </div>
        
        <script>
            const SportsLibrary = {
                async init() {
                    await this.loadRecordings();
                },
                
                async loadRecordings() {
                    const loading = document.getElementById('loadingIndicator');
                    const content = document.getElementById('recordingsContent');
                    const empty = document.getElementById('emptyState');
                    
                    try {
                        const response = await ApiClient.ajax({
                            url: ApiClient.getUrl('SportsDVR/Library'),
                            type: 'GET',
                            dataType: 'json'
                        });
                        
                        loading.style.display = 'none';
                        
                        const today = response.Today || [];
                        const week = response.ThisWeek || [];
                        const month = response.ThisMonth || [];
                        const older = response.Older || [];
                        
                        const hasRecordings = today.length > 0 || week.length > 0 || month.length > 0 || older.length > 0;
                        
                        if (!hasRecordings) {
                            empty.style.display = 'block';
                            return;
                        }
                        
                        content.style.display = 'block';
                        
                        if (today.length > 0) {
                            document.getElementById('todaySection').style.display = 'block';
                            document.getElementById('todayRecordings').innerHTML = this.renderRecordings(today);
                        }
                        
                        if (week.length > 0) {
                            document.getElementById('weekSection').style.display = 'block';
                            document.getElementById('weekRecordings').innerHTML = this.renderRecordings(week);
                        }
                        
                        if (month.length > 0) {
                            document.getElementById('monthSection').style.display = 'block';
                            document.getElementById('monthRecordings').innerHTML = this.renderRecordings(month);
                        }
                        
                        if (older.length > 0) {
                            document.getElementById('olderSection').style.display = 'block';
                            document.getElementById('olderRecordings').innerHTML = this.renderRecordings(older);
                        }
                    } catch (error) {
                        loading.style.display = 'none';
                        content.innerHTML = '<p class="fieldDescription" style="color: #f44336;">Failed to load recordings: ' + (error.message || 'Unknown error') + '</p>';
                        console.error('Failed to load recordings:', error);
                    }
                },
                
                renderRecordings(recordings) {
                    if (!recordings || recordings.length === 0) {
                        return '<p class="fieldDescription">No recordings</p>';
                    }
                    
                    let html = '';
                    recordings.forEach(recording => {
                        const date = new Date(recording.RecordedDate);
                        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const duration = recording.RunTimeTicks ? this.formatDuration(recording.RunTimeTicks) : '';
                        const size = recording.FileSize ? this.formatSize(recording.FileSize) : '';
                        
                        let details = [];
                        if (recording.League) details.push(recording.League);
                        if (recording.Team1 && recording.Team2) {
                            details.push(recording.Team1 + ' vs ' + recording.Team2);
                        }
                        if (duration) details.push(duration);
                        if (size) details.push(size);
                        
                        html += '<div class="listItem listItem-border">' +
                            '<div class="listItemBody two-line">' +
                            '<div class="listItemBodyText">' + this.escapeHtml(recording.Name) + '</div>' +
                            '<div class="listItemBodyText secondary">' + this.escapeHtml(details.join(' · ')) + ' · ' + dateStr + '</div>' +
                            '</div>' +
                            '<button is="emby-button" type="button" class="fab mini autoSize" onclick="window.location.href=\'' + recording.PlaybackUrl + '\'" title="Play"><span class="material-icons">play_arrow</span></button>' +
                            '</div>';
                    });
                    
                    return html;
                },
                
                formatDuration(ticks) {
                    const seconds = Math.floor(ticks / 10000000);
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    
                    if (hours > 0) {
                        return hours + 'h ' + minutes + 'm';
                    } else if (minutes > 0) {
                        return minutes + 'm ' + secs + 's';
                    } else {
                        return secs + 's';
                    }
                },
                
                formatSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                    return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
                },
                
                escapeHtml(text) {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
            };
            
            SportsLibrary.init();
        </script>
    </div>
</body>
</html>
